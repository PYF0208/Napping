@model IEnumerable<Napping_PJ.Areas.Admin.Models.ExtraServiceViewModel>

@{
    ViewData["Title"] = "Index";
}

<div id="app" class="container">


    <div class="form-group">
        @*篩選欄位*@
        <div class="row" style="width:50%;margin-left:auto;margin-right:0px">
            <label class="col-md-4">關鍵字:</label>
            <input class="col-md-8 form-control" placeholder="請輸入篩選關鍵字"
                   v-model="filter" @@keyup="filterExtraServices">
        </div>
    </div>
    <div class="form-group">
        @*新增按鍵*@
        <button type="button" @@click="showInsertPage " class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#modalId">
            新增加購服務選項
        </button>

    </div>
    <div class="form-group">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <td>編輯</td>
                    <td>加購服務編號</td>
                    <td>加購服務名稱</td>
                    <td>價格</td>
                    <td>旅店名稱</td>
                </tr>
            </thead>
            <tbody>
                <tr v-for="item in ExtraServiceViewModel">
                    <template v-if="item.Edit==true">
                        <td>
                            <button class="btn btn-success" @@click="update(item)">修改</button>
                            <button class="btn btn-warning" @@click="cancel">取消</button>
                        </td>
                        <td>{{ item.extraServiceId }}</td>
                        <td><input v-model="item.extraServiceName" /></td>
                        <td><input v-model="item.price" /></td>
                        <td>{{ item.hotelName }}</td>
                    </template>
                    <template v-else>
                        <td>
                            <button class="btn btn-primary" @@click="edit(item.extraServiceId)">編輯</button>
                            <button class="btn btn-danger" @@click="deleteExtraService(item.extraServiceId)">刪除</button>
                        </td>
                        <td>{{ item.extraServiceId }}</td>
                        <td>{{ item.extraServiceName }}</td>
                        <td>{{ item.price }}</td>
                        <td>{{ item.hotelName }}</td>
                    </template>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="form-group">
        @*新增加購服務選項畫面*@
        <div class="modal fade" id="insertPage" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" role="dialog" aria-labelledby="modalTitleId" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-sm" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitleId">新增加購服務選項</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">加購服務名稱:</label>
                            <input class="form-control" v-model="extraServiceName" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">價格:</label>
                            <input class="form-control" v-model="price" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">旅店名稱:</label>
                            <select class="form-control" v-model="hotelId">
                                <option v-for="item in HotelsViewModel" :value="item.hotelId">{{ item.name }}</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                        <button type="button" @@click="insert" class="btn btn-primary">新增</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14"></script>
    <script src="~/lib/axios/axios.min.js"></script>

    <script>
        let app = new Vue({
            el: '#app',
            data: {
                ExtraServiceViewModel: [],
                HotelsViewModel:[],
                filter: "",
                originalExtraServiceName: "",
                originalPrice: "",
                originalHotelId: "",
                originalHotelName: "",
                extraServiceName: "",
                price: "",
                hotelId: "",
                hotelName: ""
            },
            mounted: function () {
                let _this = this;
                _this.filterExtraServices();
                _this.getHotels();
            },
            methods: {
                filterExtraServices: function () {
                    let _this = this;
                    var request = {};
                    request.ExtraServiceId = isNaN(Number(_this.filter)) ? -1 : Number(_this.filter);
                    request.Price = isNaN(Number(_this.filter)) ? -1 : Number(_this.filter);
                    request.ExtraServiceName = request.HotelName =_this.filter;
                    axios.post('ExtraServices/FilterExtraServices', request)
                        .then(function (response) {
                            //alert(JSON.stringify(response.data));
                            _this.ExtraServiceViewModel = response.data;
                            var ExtraServiceList = [];
                            for (var i = 0; i < _this.ExtraServiceViewModel.length; i++) {
                                var item = _this.ExtraServiceViewModel[i];
                                item.Edit = false;
                                ExtraServiceList.push(item);
                            }
                            _this.ExtraServiceViewModel = ExtraServiceList;
                        });
                },
                getHotels: function () {
                    let _this = this;
                    axios.get('ExtraServices/GetHotels')
                        .then(function (response) {
                            //alert(JSON.stringify(response.data));
                            _this.HotelsViewModel = response.data;
                        });
                },
                update: function (item) {
                    //alert("update");
                    let _this = this;
                    var request = {

                        ExtraServiceId: item.extraServiceId,
                        ExtraServiceName: item.extraServiceName,
                        Price: item.price,
                        HotelId: item.hotelId,
                      
                    };
                    axios.put(`ExtraServices/PutExtraServices?Id=${item.extraServiceId}`, request).then(response => {
                        alert(response.data);
                        _this.filterExtraServices();
                        //_this.cancel();

                    });
                },
                cancel: function () {
                    //alert("cancel");
                    let _this = this;
                    var ExtraServiceList = [];
                    for (var i = 0; i < _this.ExtraServiceViewModel.length; i++) {
                        var item = _this.ExtraServiceViewModel[i];
                        if (item.Edit == true) {
                            item.Edit = false;
                            item.extraServiceName = _this.originalExtraServiceName;
                            item.price = _this.originalPrice;
                            item.hotelId = _this.originalHotelId;
                            item.hotelName = _this.originalHotelName;
                        }
                        ExtraServiceList.push(item);
                    }
                    _this.ExtraServiceViewModel = ExtraServiceList;
                },
                edit: function (extraServiceId) {
                    //alert("edit");
                    let _this = this;
                    var ExtraServiceList = [];
                    for (var i = 0; i < _this.ExtraServiceViewModel.length; i++) {
                        var item = _this.ExtraServiceViewModel[i];
                        if (extraServiceId == item.extraServiceId) {
                            item.Edit = true;
                            _this.originalExtraServiceName = item.extraServiceName;
                            _this.originalPrice = item.price;
                            _this.originalHotelId = item.hotelId;
                            _this.originalHotelName = item.hotelName;
                        }
                        ExtraServiceList.push(item);
                    }
                    _this.ExtraServiceViewModel = ExtraServiceList;
                },
                deleteExtraService: function (extraServiceId) {
                    //alert("delete");
                    let _this = this;
                    var ret = confirm('確定要刪除嗎?');
                    if (ret == true) {
                        axios.delete(`ExtraServices/DeleteExtraServices?Id=${extraServiceId}`).then(
                            response => {
                                alert(response.data);
                                _this.filterExtraServices();
                            });
                    }
                },
                showInsertPage: function () {
                    $('#insertPage').modal('show');
                },
                insert: function () {
                    let _this = this;
                    var esViewModel = {
                        ExtraServiceId: 0,
                        ExtraServiceName: _this.extraServiceName,
                        Price: _this.price,
                        HotelId: _this.hotelId
                      
                    };
                    axios.post('ExtraServices/PostExtraServices', esViewModel).then(response => {
                        alert(response.data);
                        $('#insertPage').modal('hide');
                        _this.filterExtraServices();
                        _this.extraServiceName = "";
                        _this.price = "";

                    });
                }

            }
        });

    </script>

}